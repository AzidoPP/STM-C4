# STM-C4 Ver4.0 说明

主控 STM32F103C8T6，外部 8MHz 高速晶振，使用 Keil5 + ST-Link。

A CSGO game C4 bomb model based on STM32.

## 1. LCD1601A
- 默认倒装安装（`CONFIG_LCD_NORMAL_MOUNT = 0`），正装可设为 `1`。
- 倒装时显示从右往左，字符需整体旋转 180 度；正装时按正常方向显示。
  - 例如用户看到左对齐的 `ABCDEF`，倒装实际需要显示右对齐的 `FEDCBA` 并旋转字符。
- 字符集：实际只需要 `0123456789*`（驱动内置 CGRAM 字库）。
- 采用 4 线模式。

引脚定义（硬件连接）：
- RS: PB12
- EN: PB14
- D4 ~ D7: PA4 ~ PA7
- 背光：PA3（高电平点亮，推挽，PWM 控制，亮度 `CONFIG_LCD_BACKLIGHT_PCT`）

电平/驱动：
- LCD1601A 使用 5V 电平，外部上拉到 5V。
- 信号脚使用开漏输出（OD）。

实现要点（简化说明）：
- 初始化流程与 HD44780 类似：上电延时、写入 0x03/0x02、功能设置、清屏、显示开等。
- 通过自定义 CGRAM 字库加载字符；显示方向与列映射由驱动根据 `CONFIG_LCD_NORMAL_MOUNT` 处理。
- 参考实现见：`Ver4.0/Keil_proj/c4/hardware/1601a.c`

## 2. 矩阵键盘
- 引脚：PB15 PB4 PB5 PB6 PB7 PB8 PB9
- 排列：

```
        PB5     PB15    PB7
PB4     [1]     [2]     [3]
PB9     [4]     [5]     [6]
PB8     [7]     [8]     [9]
PB6     [*]     [0]     [#]
```

## 3. 蜂鸣器
- 无源蜂鸣器（含驱动电路，MOS 管，栅极 10k 下拉）。
- 栅极连接 PB0。
- PB0 输出 PWM 波驱动。
- 原版CS2中，A区下包后倒计时音频为4250Hz，B区下包倒计时为3600Hz

## 4. LED
- PC13：系统指示 LED（一般不用，仅调试，推挽高电平点亮）。
- 用户双色 LED（推挽高电平点亮）：
  - PA2 红
  - PA1 绿
- 黄色由红绿同时点亮并用 PWM 调节比例，比例由 `CONFIG_LED_YELLOW_RED_PCT` 控制。
  - 例如 `CONFIG_LED_YELLOW_RED_PCT = 70` 表示红色约 70%、绿色 100%。

## 5. 继电器
- 已包含 MOS + 续流驱动。
- PB1 高电平：继电器吸合。
- 倒计时结束后“引爆”吸合继电器
- 端口`C`为继电器常开脚，端口`D`为继电器常闭脚。吸合后`C`脚成为GND，可以与`A`脚（VCC）产生9V电压。

## 6. MP3 模块
- PA9 串口（USART1 TX），用于播放 C4 模型音效/音乐盒。
- MP3 命令封装参考：`Ver4.0/Keil_proj/c4/hardware/Serial.c` 与 `mp3.c`。
- 常用音效映射：
  - 上电提示音：`mp3_start()`
  - 下包完成：`mp3_over()`
  - 爆炸音效：`mp3_boom()`
  - 爆炸音乐盒：`mp3_boom_music()`

音乐序号（文件夹/曲目编号）：请参考[TFCard_Files/README.md](TFCard_Files/README.md)

## 7. 外部“拆弹器”
- PB3 上拉输入，低电平有效。
- PB3 外部持续下拉达到 `CONFIG_EXTERNAL_DEFUSE_MS` 即判定拆弹成功（默认 5000ms）。

## 流程（完整）
1. LED 黄色呼吸灯模式（`CONFIG_LED_BREATH_PERIOD_MS`）。
2. 上电提示音：`CONFIG_BUZZER_STARTUP_FREQ_HZ` + `CONFIG_STARTUP_BEEP_ON_MS` / `CONFIG_STARTUP_BEEP_GAP_MS`。
3. 倒计时蜂鸣器频率：`CONFIG_BUZZER_COUNTDOWN_FREQ_HZ`。
4. 等待输入密码（长度 `CONFIG_PASSWORD_LEN`）。输入完成后延迟 `CONFIG_ARM_DELAY_MS` 再进入倒计时，避免误触。
5. 记录该密码（输入期间 LED 仍为呼吸灯）。
6. 进入倒计时（总时长 `CONFIG_COUNTDOWN_MS`）：
   - 蜂鸣节奏由 `CONFIG_BEEP_LEN_MS` 与 `CONFIG_BEEP_INTERVAL_*` 控制
   - 每次蜂鸣时 LED 红色，非蜂鸣时 LED 熄灭

## 倒计时蜂鸣模式
原 CS:GO C4 蜂鸣公式如下（BPS = Beeps Per Second）：

```
f(t) = 1.05 · exp(0.0054t + 0.000871t²)
```
- t：时间（秒），0 ≤ t ≤ 45

更通用的比例形式：
```
g(p) = 1.049 · exp(0.244p + 1.764p²)
```
- p：已过去时间比例，0.0 ≤ p ≤ 1.0

蜂鸣长度固定为 125ms。

频率：
```
freq = MAX(0.1 + 0.9 * fComplete, 0.15)
```
- fComplete 为剩余时间比例（40/40 到 0/40）
- 下包后设置下一次蜂鸣时间：`gpGlobals->curtime + 1.0`

倒计时的时候显示\*滚动，由于LCD屏幕显示有延迟，所以实际显示***，这样人眼看起来就是一个\*，连续3帧的位置颜色最深

注意：LCD1601A 是倒装的，所以符号位置与显示方向需整体翻转 180°。

## 倒计时拆弹（3 种方式，且必须非阻塞）
> 拆弹失败或进行中都不应影响倒计时精度。旧版本因键盘扫描 + 倒计时循环阻塞，长按按键会导致消抖延时叠加、倒计时不准。V4.0 采用时间基准 + 状态机避免此问题。

1. **输入密码拆弹**：输入与下包相同密码即成功（`CONFIG_DEFUSE_ENABLE_PASSWORD`）。
2. **长按 # 手动拆弹**：长按超过 `CONFIG_LONG_PRESS_MS` 后开始拆弹，持续 `CONFIG_MANUAL_DEFUSE_MS` 即成功（`CONFIG_DEFUSE_ENABLE_MANUAL`）。
   - 过程显示：每一位数字按 `CONFIG_DEFUSE_CYCLE_STEPS` 循环后定格，再进入下一位。
3. **外部拆弹器拆弹**：PB3 触发后开始拆弹，持续 `CONFIG_EXTERNAL_DEFUSE_MS` 即成功（`CONFIG_DEFUSE_ENABLE_EXTERNAL`）。

拆弹成功会播放成功音效。

## 爆炸行为
- 倒计时结束未拆弹：继电器吸合。
- 播放爆炸音效或音乐盒（`CONFIG_MP3_EXPLOSION_ENABLE` / `CONFIG_MP3_EXPLOSION_USE_MUSIC`）。
- LED 输出 100% 黄色（LED 与音乐盒同时）。

## 软件架构（文件职责）
- `Ver4.0/Keil_proj/c4/user/main.c`
  - 应用状态机与主循环（Idle/Countdown/Success/Exploded）
  - 倒计时逻辑、拆弹流程、输入处理
- `Ver4.0/Keil_proj/c4/sys/Systick.c`
  - 1ms 时间基准（TIM4 中断）
- `Ver4.0/Keil_proj/c4/user/stm32f10x_it.c`
  - TIM4 中断处理，驱动时间基准
- `Ver4.0/Keil_proj/c4/hardware/MatrixKey.c`
  - 矩阵键盘扫描与消抖
- `Ver4.0/Keil_proj/c4/hardware/1601a.c`
  - LCD1601A 驱动（倒装/正装显示、CGRAM 字库、背光 PWM）
- `Ver4.0/Keil_proj/c4/hardware/LED.c`
  - 红/绿 LED PWM、黄色配比、继电器控制
  - 蜂鸣器 PWM 频率与占空比控制
- `Ver4.0/Keil_proj/c4/hardware/Serial.c`
  - USART1 发送封装（供 MP3 模块使用）
- `Ver4.0/Keil_proj/c4/hardware/mp3.c`
  - MP3 指令封装
- `Ver4.0/Keil_proj/c4/sys/Delay.c`
  - 短时硬件延时（LCD 时序/少量效果）
- `Ver4.0/Keil_proj/c4/user/config.h`
  - 功能开关与参数配置
- `Ver4.0/Keil_proj/c4/user/config_range.h`
  - 配置范围检查

## 配置入口
配置集中在 `Ver4.0/Keil_proj/c4/user/config.h`，并提供中英文默认模板：
- `Ver4.0/Keil_proj/c4/user/default_config_CH.h`
- `Ver4.0/Keil_proj/c4/user/default_config_EN.h`

常用配置（宏）：
- 密码与上电：`CONFIG_PASSWORD_LEN` / `CONFIG_PASSWORD_COL` / `CONFIG_ARM_DELAY_MS` / `CONFIG_ARM_PRESET_ENABLE` / `CONFIG_ARM_PRESET_PASSWORD`
- 倒计时与滚动：`CONFIG_COUNTDOWN_MS` / `CONFIG_SCROLL_INTERVAL_MS` / `CONFIG_SCROLL_PATTERN_LEN`（预留，当前实现固定三颗星）
- 蜂鸣器节奏：`CONFIG_BEEP_LEN_MS` / `CONFIG_BEEP_INTERVAL_BASE_MS` / `CONFIG_BEEP_INTERVAL_SCALE_MS` / `CONFIG_BEEP_INTERVAL_MIN_MS` / `CONFIG_BEEP_INITIAL_MS`
- 蜂鸣器频率：`CONFIG_BUZZER_STARTUP_FREQ_HZ` / `CONFIG_BUZZER_COUNTDOWN_FREQ_HZ` / `CONFIG_BUZZER_DUTY_PCT`
- 拆弹设置：`CONFIG_DEFUSE_ENABLE_PASSWORD` / `CONFIG_DEFUSE_ENABLE_MANUAL` / `CONFIG_DEFUSE_ENABLE_EXTERNAL`
- 拆弹时间与过程：`CONFIG_LONG_PRESS_MS` / `CONFIG_MANUAL_DEFUSE_MS` / `CONFIG_EXTERNAL_DEFUSE_MS` / `CONFIG_DEFUSE_CYCLE_STEPS` / `CONFIG_DEFUSE_DISPLAY_HOLD_MS`
- 拆弹成功显示：`CONFIG_DEFUSE_BLINK_MS`（当前生效）/ `CONFIG_DEFUSE_FLASH_TOGGLE_MS` / `CONFIG_DEFUSE_FLASH_TOGGLES`（预留）
- LCD/LED：`CONFIG_LCD_COLS` / `CONFIG_LCD_BACKLIGHT_PCT` / `CONFIG_LCD_NORMAL_MOUNT` / `CONFIG_LED_PWM_MAX` / `CONFIG_LED_BREATH_PERIOD_MS` / `CONFIG_LED_YELLOW_RED_PCT`
- MP3：`CONFIG_MP3_VOLUME` / `CONFIG_MP3_ARM_SUCCESS_ENABLE` / `CONFIG_MP3_EXPLOSION_ENABLE` / `CONFIG_MP3_EXPLOSION_USE_MUSIC`

## 工程与编译
Keil 工程文件：`Ver4.0/Keil_proj/c4/Project.uvprojx`

